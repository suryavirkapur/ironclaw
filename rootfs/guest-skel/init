#!/bin/sh
set -e
exec >/dev/ttyS0 2>&1

echo "ironclaw guest init: starting"
export PATH=/bin:/sbin:/usr/bin:/usr/sbin

# Minimal mounts
mount -t proc proc /proc || true
mount -t sysfs sysfs /sys || true
mount -t devtmpfs devtmpfs /dev || true
mount -t tmpfs tmpfs /tmp || true

# Networking (optional)
ip link set lo up || true
ip link set eth0 up || true

# Load vsock kernel modules if present (best effort).
# Needed on many distros where vsock is modular.
if [ -f /lib/modules/vsock.ko ]; then
  echo "ironclaw guest init: loading vsock modules"
  insmod /lib/modules/vsock.ko || true
  insmod /lib/modules/vmw_vsock_virtio_transport_common.ko || true
  insmod /lib/modules/vmw_vsock_virtio_transport.ko || true
  insmod /lib/modules/vhost_iotlb.ko || true
  insmod /lib/modules/vhost.ko || true
  insmod /lib/modules/vhost_vsock.ko || true
fi

# Vsock transport
export IRONCLAW_VSOCK=1
export IRONCLAW_VSOCK_PORT=${IRONCLAW_VSOCK_PORT:-5000}

# Guest config
export IROWCLAW_CONFIG=${IROWCLAW_CONFIG:-/mnt/brain/config/irowclaw.toml}

# Run guest runtime (do not exec as PID1; keep init alive if it crashes)
if [ -x /bin/irowclaw ]; then
  echo "ironclaw guest init: starting /bin/irowclaw"
  set +e
  while true; do
    /bin/irowclaw
    code=$?
    echo "ironclaw guest init: irowclaw exited code=${code}, restarting in 1s"
    sleep 1
  done
fi

echo "ironclaw guest init: missing /bin/irowclaw"
while true; do sleep 3600; done
